// Prisma schema для NLMKblablaCAR
// Поддерживает SQLite (разработка) и PostgreSQL (продакшен)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============
// SQLite не поддерживает enum, поэтому используем String
// При переходе на PostgreSQL можно раскомментировать enum

// enum City {
//   Moscow
//   Lipetsk
// }

// enum Role {
//   Driver
//   Passenger
//   Both
// }

// enum MusicPref {
//   Quiet
//   Normal
//   Loud
// }

// enum BaggageSize {
//   Hand
//   Medium
//   Suitcase
// }

// enum ConversationPref {
//   Chatty
//   Quiet
// }

// ============ MODELS ============

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatarUrl String   @default("")
  phone     String   @default("")
  bio       String   @default("")
  position  String   @default("")
  homeCity  String   @default("Moscow") // City enum
  role      String   @default("Passenger") // Role enum
  rating    Float    @default(5.0)
  
  // Preferences (embedded as JSON or separate fields)
  prefMusic        String  @default("Normal") // MusicPref
  prefSmoking      Boolean @default(false)
  prefPets         Boolean @default(false)
  prefBaggage      String  @default("Hand") // BaggageSize
  prefConversation String  @default("Chatty") // ConversationPref
  prefAc           Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  tripsAsDriver      Trip[]              @relation("DriverTrips")
  bookings           Booking[]
  reviewsGiven       Review[]            @relation("ReviewAuthor")
  reviewsReceived    Review[]            @relation("ReviewTarget")
  passengerRequests  PassengerRequest[]  @relation("PassengerRequests")
}

model Trip {
  id              String   @id @default(cuid())
  
  // Driver
  driverId        String
  driver          User     @relation("DriverTrips", fields: [driverId], references: [id])
  
  // Route
  fromCity        String   // City enum: "Moscow" | "Lipetsk"
  toCity          String   // City enum
  date            String   // ISO Date: YYYY-MM-DD
  time            String   // HH:mm
  pickupLocation  String
  dropoffLocation String

  // Coordinates (from Yandex Maps)
  pickupLat       Float?   // Latitude for pickup location
  pickupLng       Float?   // Longitude for pickup location
  dropoffLat      Float?   // Latitude for dropoff location
  dropoffLng      Float?   // Longitude for dropoff location
  
  // Seats
  seatsTotal      Int      @default(3)
  seatsBooked     Int      @default(0)
  
  // Preferences (copied from driver at creation time)
  prefMusic        String  @default("Normal")
  prefSmoking      Boolean @default(false)
  prefPets         Boolean @default(false)
  prefBaggage      String  @default("Hand")
  prefConversation String  @default("Chatty")
  prefAc           Boolean @default(true)
  
  comment         String   @default("")
  
  // Trip grouping (outbound + return)
  tripGroupId     String?
  isReturn        Boolean  @default(false)
  
  // Status
  status          String   @default("active") // active, completed, cancelled, archived
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  bookings        Booking[]
  reviews         Review[]
  linkedRequests  PassengerRequest[] @relation("RequestTrip")

  // Indexes for query optimization
  @@index([status])                    // Filter by status
  @@index([driverId])                  // Driver's trips
  @@index([date])                      // Sort/filter by date
  @@index([status, date])              // Active trips sorted by date
  @@index([fromCity, toCity, status])  // Route search
}

model Booking {
  id          String   @id @default(cuid())
  
  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  passengerId String
  passenger   User     @relation(fields: [passengerId], references: [id])
  
  status      String   @default("confirmed") // pending, confirmed, cancelled
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tripId, passengerId]) // Один пассажир - одна бронь на поездку

  // Indexes for query optimization
  @@index([passengerId])          // User's bookings
  @@index([tripId])               // Trip's bookings
  @@index([passengerId, status])  // User's active bookings
}

model Review {
  id        String   @id @default(cuid())

  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id])

  authorId  String
  author    User     @relation("ReviewAuthor", fields: [authorId], references: [id])

  targetId  String
  target    User     @relation("ReviewTarget", fields: [targetId], references: [id])

  rating    Int      // 1-5 (0 если пропущен)
  comment   String   @default("")
  skipped   Boolean  @default(false) // true если отзыв пропущен

  createdAt DateTime @default(now())

  @@unique([tripId, authorId, targetId]) // Один отзыв на поездку от автора к цели

  // Indexes for query optimization
  @@index([tripId])    // Trip's reviews
  @@index([targetId])  // Reviews about user (for rating calculation)
  @@index([authorId])  // Reviews by user
}

model PassengerRequest {
  id              String   @id @default(cuid())

  // Requester
  requesterId     String
  requester       User     @relation("PassengerRequests", fields: [requesterId], references: [id])

  // Route
  fromCity        String   // "Moscow" | "Lipetsk"
  toCity          String   // "Moscow" | "Lipetsk"

  // Date flexibility
  dateFrom        String   // ISO Date: YYYY-MM-DD (earliest acceptable date)
  dateTo          String   // ISO Date: YYYY-MM-DD (latest acceptable date)
  timePreferred   String?  // HH:mm (optional preferred time)

  // Passengers
  passengersCount Int      @default(1) // 1-3 passengers needed

  // Preferences (same as Trip)
  prefMusic        String  @default("Normal")
  prefSmoking      Boolean @default(false)
  prefPets         Boolean @default(false)
  prefBaggage      String  @default("Hand")
  prefConversation String  @default("Chatty")
  prefAc           Boolean @default(true)

  // Additional info
  comment         String   @default("")

  // Status: pending, fulfilled, cancelled, expired
  status          String   @default("pending")

  // Link to matched trip (when fulfilled)
  linkedTripId    String?
  linkedTrip      Trip?    @relation("RequestTrip", fields: [linkedTripId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Indexes for efficient querying
  @@index([status])
  @@index([requesterId])
  @@index([fromCity, toCity, status])
  @@index([dateFrom, dateTo])
}
