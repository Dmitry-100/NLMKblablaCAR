# ADR-003: Prisma ORM для работы с базой данных

**Статус:** Принято
**Дата:** 2024-01
**Автор:** Команда разработки

## Контекст

Backend приложения требует взаимодействия с PostgreSQL базой данных. Необходимо выбрать подход к работе с БД, который обеспечит:
- Типобезопасность запросов (TypeScript)
- Управление миграциями схемы
- Защиту от SQL-инъекций
- Удобство разработки и отладки

## Решение

Выбран **Prisma ORM** как основной инструмент для работы с базой данных.

```typescript
// Пример схемы (prisma/schema.prisma)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  trips     Trip[]   @relation("DriverTrips")
  bookings  Booking[]
}

model Trip {
  id        String   @id @default(cuid())
  driver    User     @relation("DriverTrips", fields: [driverId], references: [id])
  driverId  String
  bookings  Booking[]
}

// Типобезопасный запрос
const trip = await prisma.trip.findUnique({
  where: { id },
  include: {
    driver: true,
    bookings: { include: { passenger: true } }
  }
});
```

## Альтернативы

### 1. Raw SQL / pg библиотека
- **Плюсы**: Полный контроль, максимальная производительность
- **Минусы**: Нет типобезопасности, ручное управление миграциями, риск SQL-инъекций

### 2. Knex.js (Query Builder)
- **Плюсы**: Гибкость, близость к SQL, хорошая производительность
- **Минусы**: Нет автогенерации типов, ручное определение моделей

### 3. TypeORM
- **Плюсы**: Зрелый, декораторы для моделей, Active Record паттерн
- **Минусы**: Сложная конфигурация, проблемы с типами в сложных запросах

### 4. Drizzle ORM
- **Плюсы**: Легковесный, SQL-like синтаксис, отличная производительность
- **Минусы**: Молодой проект, меньше документации (на момент выбора)

## Последствия

### Положительные
- **Полная типобезопасность**: Автогенерация TypeScript типов из схемы
- **Prisma Studio**: Визуальный редактор данных для отладки
- **Автомиграции**: `prisma db push` для быстрого прототипирования
- **Защита от SQL-инъекций**: Параметризованные запросы по умолчанию
- **Relation handling**: Удобная работа со связями через `include`
- **Отличная документация**: Подробные примеры и guides

### Отрицательные
- **Абстракция от SQL**: Сложные запросы могут быть неоптимальными
- **Размер бандла**: Prisma Client добавляет ~2MB к node_modules
- **Query Engine**: Отдельный бинарный файл для выполнения запросов
- **Ограничения**: Некоторые SQL-фичи недоступны напрямую
- **Lock-in**: Специфичная схема, сложно мигрировать на другой ORM

### Технический долг
- Необходимо добавить индексы для часто используемых полей (email, date, status)
- Рассмотреть `prisma migrate` вместо `db push` для production

## Связанные решения

- ADR-002: PostgreSQL как СУБД
- ADR-016: Zod для валидации (дублирование типов Prisma)
